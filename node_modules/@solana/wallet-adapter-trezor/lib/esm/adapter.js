import { BaseSignerWalletAdapter, WalletAccountError, WalletConfigError, WalletDisconnectedError, WalletDisconnectionError, WalletLoadError, WalletNotConnectedError, WalletNotReadyError, WalletPublicKeyError, WalletReadyState, WalletSignTransactionError, isVersionedTransaction, } from '@solana/wallet-adapter-base';
import { PublicKey } from '@solana/web3.js';
import './polyfills/index.js';
export const TrezorWalletName = 'Trezor';
export class TrezorWalletAdapter extends BaseSignerWalletAdapter {
    constructor(config = {}) {
        super();
        this.name = TrezorWalletName;
        this.url = 'https://trezor.io';
        this.icon = 'data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjEwOCIgd2lkdGg9IjEwOCIgdmlld0JveD0iMCAwIDEwOCAxMDgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0ibTU0IDBjMjkuODI0MjE5IDAgNTQgMjQuMTc1NzgxIDU0IDU0cy0yNC4xNzU3ODEgNTQtNTQgNTQtNTQtMjQuMTc1NzgxLTU0LTU0IDI0LjE3NTc4MS01NCA1NC01NHptMCAwIiBmaWxsPSIjZmZmIi8+PHBhdGggZD0ibTU0LjA0Njg3NSAxMC4xMjVjLTEyLjEwNTQ2OSAwLTIxLjkwNjI1IDEwLjExNzE4OC0yMS45MDYyNSAyMi42MTcxODh2OC40NzY1NjJjLTQuMjUuNzk2ODc1LTguNTE1NjI1IDEuODU1NDY5LTguNTE1NjI1IDMuMjMwNDY5djQ0LjIzODI4MXMwIDEuMjIyNjU2IDEuMzMyMDMxIDEuODAwNzgxYzQuODI0MjE5IDIuMDE5NTMxIDIzLjgxMjUgOC45NTcwMzEgMjguMTc1NzgxIDEwLjU0Njg3NS41NjI1LjIxNDg0NC43MTg3NS4yMTQ4NDQuODY3MTg4LjIxNDg0NC4yMDcwMzEgMCAuMzA0Njg4IDAgLjg2NzE4OC0uMjE0ODQ0IDQuMzYzMjgxLTEuNTg5ODQ0IDIzLjM5ODQzNy04LjUyNzM0NCAyOC4yMjY1NjItMTAuNTQ2ODc1IDEuMjM0Mzc1LS41MjczNDMgMS4yODEyNS0xLjc1IDEuMjgxMjUtMS43NXYtNDQuMjg5MDYyYzAtMS4zNzUtNC4yMDMxMjUtMi40ODQzNzUtOC40Njg3NS0zLjIzMDQ2OXYtOC40NzY1NjJjLjA2MjUtMTIuNS05Ljc5Njg3NS0yMi42MTcxODgtMjEuODU5Mzc1LTIyLjYxNzE4OHptMCAxMC44MDg1OTRjNy4xMzY3MTkgMCAxMS40NDkyMTkgNC40NTMxMjUgMTEuNDQ5MjE5IDExLjgyMDMxMnY3LjM2NzE4OGMtOC0uNTc4MTI1LTE0LjgzMjAzMi0uNTc4MTI1LTIyLjg4MjgxMyAwdi03LjM2NzE4OGMwLTcuMzc4OTA2IDQuMzEyNS0xMS44MjAzMTIgMTEuNDMzNTk0LTExLjgyMDMxMnptLS4wNDY4NzUgMzAuMDM1MTU2YzkuOTU3MDMxIDAgMTguMzE2NDA2Ljc5Njg3NSAxOC4zMTY0MDYgMi4yMjI2NTZ2MjcuNTk3NjU2YzAgLjQyOTY4OC0uMDUwNzgxLjQ4MDQ2OS0uNDE3OTY4LjYzMjgxMy0uMzUxNTYzLjE2NDA2My0xNi45ODA0NjkgNi4zNTU0NjktMTYuOTgwNDY5IDYuMzU1NDY5cy0uNjcxODc1LjIxNDg0NC0uODcxMDk0LjIxNDg0NGMtLjIwNzAzMSAwLS44NjcxODctLjI2NTYyNi0uODY3MTg3LS4yNjU2MjZzLTE2LjYyODkwNy02LjE5MTQwNi0xNi45ODA0NjktNi4zNTU0NjhjLS4zNTU0NjktLjE2NDA2My0uNDE3OTY5LS4yMTQ4NDQtLjQxNzk2OS0uNjMyODEzdi0yNy41OTc2NTZjLS4wOTc2NTYtMS40MjU3ODEgOC4yNjE3MTktMi4xNzE4NzUgMTguMjE4NzUtMi4xNzE4NzV6bTAgMCIvPjwvc3ZnPg==';
        this.supportedTransactionVersions = new Set(['legacy', 0]);
        this._readyState = typeof window === 'undefined' || typeof document === 'undefined'
            ? WalletReadyState.Unsupported
            : WalletReadyState.Loadable;
        this._onDeviceEvent = (event) => {
            if (event.type === 'device-disconnect') {
                this._disconnected();
            }
        };
        this._disconnected = async () => {
            const wallet = this._wallet;
            if (wallet) {
                this._wallet = null;
                this._publicKey = null;
                try {
                    wallet.off('DEVICE_EVENT', this._onDeviceEvent);
                    wallet.dispose();
                }
                catch (error) {
                    this.emit('error', new WalletDisconnectionError(error?.message, error));
                }
                this.emit('error', new WalletDisconnectedError());
                this.emit('disconnect');
            }
        };
        this._derivationPath = config.derivationPath || `m/44'/501'/0'/0'`;
        this._wallet = null;
        this._connectUrl = config.connectUrl?.replace(/\/*$/, '/');
        this._connecting = false;
        this._publicKey = null;
    }
    get publicKey() {
        return this._publicKey;
    }
    get connecting() {
        return this._connecting;
    }
    get readyState() {
        return this._readyState;
    }
    async connect() {
        try {
            if (this.connected || this.connecting)
                return;
            if (this._readyState !== WalletReadyState.Loadable)
                throw new WalletNotReadyError();
            this._connecting = true;
            let wallet;
            try {
                const { default: TrezorConnect } = await import('@trezor/connect-web');
                // @ts-expect-error // HACK: TrezorConnect.default is undefined.
                wallet = TrezorConnect.default;
            }
            catch (error) {
                throw new WalletLoadError(error?.message, error);
            }
            try {
                await wallet.init({
                    manifest: {
                        email: 'gabriel.kerekes@vacuumlabs.com',
                        appUrl: window.location.href,
                    },
                    lazyLoad: true,
                    ...(this._connectUrl
                        ? {
                            connectSrc: this._connectUrl,
                            iframeSrc: this._connectUrl,
                        }
                        : {}),
                });
            }
            catch (error) {
                throw new WalletConfigError(error?.message, error);
            }
            let result;
            try {
                result = await wallet.solanaGetPublicKey({ path: this._derivationPath });
            }
            catch (error) {
                throw new WalletAccountError(error?.message, error);
            }
            if (!result.success) {
                throw new WalletAccountError(result.payload?.error, result.payload);
            }
            let publicKey;
            try {
                publicKey = new PublicKey(Buffer.from(result.payload.publicKey, 'hex'));
            }
            catch (error) {
                throw new WalletPublicKeyError(error?.message, error);
            }
            wallet.on('DEVICE_EVENT', this._onDeviceEvent);
            this._wallet = wallet;
            this._publicKey = publicKey;
            this.emit('connect', publicKey);
        }
        catch (error) {
            this.emit('error', error);
            throw error;
        }
        finally {
            this._connecting = false;
        }
    }
    async disconnect() {
        const wallet = this._wallet;
        if (wallet) {
            this._wallet = null;
            this._publicKey = null;
            try {
                wallet.off('DEVICE_EVENT', this._onDeviceEvent);
                await wallet.dispose();
            }
            catch (error) {
                this.emit('error', new WalletDisconnectionError(error?.message, error));
            }
            this.emit('disconnect');
        }
    }
    async signTransaction(transaction) {
        try {
            const wallet = this._wallet;
            const publicKey = this._publicKey;
            if (!wallet || !publicKey)
                throw new WalletNotConnectedError();
            const serializedTransaction = isVersionedTransaction(transaction)
                ? transaction.message.serialize()
                : transaction.serializeMessage();
            let result;
            try {
                result = await wallet.solanaSignTransaction({
                    path: this._derivationPath,
                    serializedTx: Buffer.from(serializedTransaction).toString('hex'),
                });
            }
            catch (error) {
                throw new WalletSignTransactionError(error?.message, error);
            }
            if (!result.success) {
                throw new WalletSignTransactionError(result.payload?.error, result.payload);
            }
            try {
                const signature = Buffer.from(result.payload.signature, 'hex');
                transaction.addSignature(publicKey, signature);
            }
            catch (error) {
                throw new WalletSignTransactionError(error?.message, error);
            }
            return transaction;
        }
        catch (error) {
            this.emit('error', error);
            throw error;
        }
    }
}
//# sourceMappingURL=adapter.js.map